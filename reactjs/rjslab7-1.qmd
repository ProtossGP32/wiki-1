---
title: "Lab#RE07-1: traffic lights simulation"
subtitle: ReactJS labs
author: albertprofe
date: "06/01/2021"
date-modified: last-modified
date-format: full
description: labs
categories: [reactjs, lab, Lab#RE07]
toc: true
number-sections: true
format:
  html
---

::: {.labs}
üìò **React JS Lab#RE07-1: Traffic Lights Simulation**

In this lab, we'll delve into building a **traffic lights simulation** using `React.js`. Here's an overview of what we'll cover:

1. **Project Setup**: We'll kick off by creating a new React project using **Vite**, a modern build tool.
   1. With Vite's fast build times, we'll set up our project environment swiftly.

2. **CSS Inline Styling**: Instead of separate CSS files, we'll utilize inline styling for our components.
   1. This approach keeps our styling concise and localized within each component.

3. **JSX Components**: We'll dive into JSX, a syntax extension for JavaScript often used with React. JSX allows us to write HTML-like code within JavaScript, making it seamless to create UI components.

4. **Business Logic Management with Hooks, Literal Objects & timout**: 
   1. We'll leverage `literal objects` for organized state management.
   2. We'll manage our <marl>form state using React hooks</mark> like (these hooks empower us to handle stateful logic effectively within functional components):
      1.  `useState`,
      2.  `useMemo`,
      3.  `useContext`,
      4.  and `useEffect`
   
   3. `Timeouts for Simulation Logic`: We'll incorporate **timeouts** to control the simulation flow.
      1. Timeouts allow us to delay certain actions, such as changing traffic light colors or updating pedestrian movements, adding an interactive and dynamic element to our traffic lights simulation.
   
5. **Form Management**: We'll dive into forms to manage **user data**
   1. **Axios**: we will use `axios` to persist our data at *fake-server* [mockapi](https://mockapi.io/){.external target='_blank'}


By the end of this lab, you'll have gained hands-on experience in React.js development, mastering essential concepts like state management, JSX rendering, component styling, and integrating timeouts for simulation logic. This project serves as an engaging introduction to building dynamic web applications with React. 


:::

</br>

# References

## Scripts and tools

**`React.dev` scripts**

<details>
<summary>**Implement a traffic light**</summary>
Here is a crosswalk light component that toggles when the button is pressed:

- [Implement a traffic light](https://react.dev/learn/state-as-a-snapshot#challenges){.external target='_blank'}
- [codesandbox **walking**](https://codesandbox.io/p/sandbox/react-dev-mzqnh7?file=%2Fsrc%2FApp.js&utm_medium=sandpack){.external target='_blank'}
</details>



<details>
<summary>**Fix a request counter**</summary>
You‚Äôre working on an art marketplace app that lets the user submit multiple orders for an art item at the same time. Each time the user presses the ‚ÄúBuy‚Äù button, the ‚ÄúPending‚Äù counter should increase by one. After three seconds, the ‚ÄúPending‚Äù counter should decrease, and the ‚ÄúCompleted‚Äù counter should increase.

> However, the ‚ÄúPending‚Äù counter does not behave as intended. When you press ‚ÄúBuy‚Äù, it decreases to -1 (which should not be possible!). And if you click fast twice, both counters seem to behave unpredictably.

Why does this happen? Fix both counters.

- [Implement a traffic light](https://react.dev/learn/queueing-a-series-of-state-updates#fix-a-request-counter){.external target='_blank'}
- [codesandbox **marketplace**](https://codesandbox.io/p/sandbox/react-dev-hl8cxc?file=%2Fsrc%2FApp.js&utm_medium=sandpack){.external target='_blank'}
</details>


<details>
<summary>**Treat state as read-only**</summary>
In other words, you should treat any JavaScript object that you put into state as read-only.

This example holds an object in state to represent the current pointer position. The red dot is supposed to move when you touch or move the cursor over the preview area. But the dot stays in the initial position:


- [Treat state as read-only](https://react.dev/learn/updating-objects-in-state#treat-state-as-read-only){.external target='_blank'}
- [codesandbox **red-point**](https://codesandbox.io/p/sandbox/react-dev-5tfwx3?file=%2Fsrc%2FApp.js&utm_medium=sandpack){.external target='_blank'}
</details>


<details>
<summary>**Copying objects with the spread syntax**</summary>
In the previous example, the position object is always created fresh from the current cursor position. But often, you will want to include existing data as a part of the new object you‚Äôre creating. For example, you may want to update only one field in a form, but keep the previous values for all other fields.

These input fields don‚Äôt work because the onChange handlers mutate the state:

- [Copying objects with the spread syntax](https://react.dev/learn/updating-objects-in-state#copying-objects-with-the-spread-syntax){.external target='_blank'}
- [codesandbox **form**](https://codesandbox.io/p/sandbox/react-dev-xjd24m?file=%2Fsrc%2FApp.js&utm_medium=sandpack){.external target='_blank'}

</details>


<details>
<summary>**Updating Arrays in State**</summary>
Arrays are mutable in JavaScript, but you should treat them as immutable when you store them in state. Just like with objects, when you want to update an array stored in state, you need to create a new one (or make a copy of an existing one), and then set state to use the new array.

- [Updating Arrays in State](https://react.dev/learn/updating-arrays-in-state){.external target='_blank'}
- [codesandbox **sculptors**](https://codesandbox.io/p/sandbox/react-dev-yy44zn?file=%2Fsrc%2FApp.js&utm_medium=sandpack){.external target='_blank'}
</details>


**Initial `SPA` projects `codesandbox`**

- Basic business logic: [trafficlights SPA 1.0.1](https://codesandbox.io/p/sandbox/trafficslights-v1-0-1-thjt2d){.external target='_blank'}
- `Axios` and Api `Rest`: [trafficlights SPA 1.2.1](https://codesandbox.io/p/sandbox/trafficslights-v1-2-1-4znjj6){.external target='_blank'}
- `useContext` to decouple `axios` from render: [trafficlights SPA 1.3.0](https://codesandbox.io/p/sandbox/trafficslights-v1-3-0-9hs8rw){.external target='_blank'}

::: {.column-margin}
 ![useContext in trafficlights SPA 1.3.0](/images/ifcd0210-24/photo_2024-03-09_06-29-18.jpg){.lightbox}
:::

# Create project

## Vite

> Next Generation Frontend Tooling: Get ready for a development environment that can finally catch up with you.

- [Vite](https://vitejs.dev/){.external target='_blank'}
- [Getting Started | Vite](https://vitejs.dev/guide/)

```{.sh .code-overflow-wrap filename="bash.sh"}
$ node -v
```

To create a new Vite project, open your terminal and run the following command:

```{.sh .code-overflow-wrap filename="bash.sh"}
$ npm create vite@latest <my-project>
```
Select `React` framework:

```{.sh .code-overflow-wrap filename="bash.sh"}
‚úî Project name: ‚Ä¶ vite-project
? Select a framework: ‚Ä∫ - Use arrow-keys. Return to submit.
    Vanilla
    Vue
‚ùØ   React
    Preact
    Lit
    Svelte
```

And `js`:

```{.sh .code-overflow-wrap filename="bash.sh"}
? Select a variant: ‚Ä∫ - Use arrow-keys. Return to submit.
‚ùØ   JavaScript
    TypeScript
```

Output:

```{.sh .code-overflow-wrap filename="bash.sh"}
Scaffolding project in /Users/carlosazaustre/dev/vite-project...

Done. Now run:

  cd vite-project
  npm install
  npm run dev
```

## Exposing port

[npm run dev --host network: not exposed](https://stackoverflow.com/questions/71939532/npm-run-dev-host-network-not-exposed)

```{.json .code-overflow-wrap filename="package.json"}
 "scripts": {
    "dev": "vite --host --port 8888",
   .....  what ever else was here.....
  },
```

## Shortcuts

```{.json .code-overflow-wrap filename="package.json"}
 "scripts": {
    "dev": "vite --host --port 8888",
   .....  what ever else was here.....
  },
```

# Mock-up

Whe should [evolve](https://www.dhiwise.com/post/single-page-application-vs-multi-page-application){.external target='_blank'} the project from a SPA to **multi-page** `react-router-dom` site.

From these `basic mockup SPA` versions:

- Basic business logic: [trafficlights SPA 1.0.1](https://codesandbox.io/p/sandbox/trafficslights-v1-0-1-thjt2d){.external target='_blank'}
- `Axios` and Api `Rest`: [trafficlights SPA 1.2.1](https://codesandbox.io/p/sandbox/trafficslights-v1-2-1-4znjj6){.external target='_blank'}
- `useContext` to decouple `axios` from render: [trafficlights SPA 1.3.0](https://codesandbox.io/p/sandbox/trafficslights-v1-3-0-9hs8rw){.external target='_blank'}

To a `multi-page two domains` site:

- home/**simulation**
- and user/**mySimulations**

![Mockup draft](/images/reactjs/trafficlights-mockup.drawio.png) 


# Step-by-step code


## React functions & components

```{.js .code-overflow-wrap filename="index.js"}
import React from 'react';
import ReactDOM from 'react-dom/client';
import App from './App';

const root = 
ReactDOM.createRoot(
          document.getElementById('root'));
root.render(<App />);

```
## Core Business logic & use case

This first iteration defines a React functional component called `RequestTracker`, <mark>which simulates a traffic light and tracks pedestrian crossings</mark>.

It uses the `useState` hook to manage **four state variables**:

- **pending** (number of pedestrians waiting),
- **walking** (number of pedestrians crossing),
- **completed** (number of completed crossings),
- and **light** (status of the traffic light).

::: {.column-margin}

The UI displays the current counts of pending, walking, and completed pedestrians, and the color of the text changes based on the status of the traffic light. The button's color also changes to reflect the traffic light's color.
:::

When the user clicks the "Traffic Light" `button`, the `handleTrafficLightClick` function is **triggered**. It decrements pending, increments walking, and sets the light to green. After a **delay of 5 seconds**, it decrements walking, increments completed, and sets the light to red.

The code uses the `<>` (fragment) syntax to group multiple elements without introducing an additional parent node.




::: {.column-page-right}
```{.js .code-overflow-wrap filename="App.jsx"}
import { useState } from "react";

export default function RequestTracker() {
  const [pending, setPending] = useState(100);
  const [walking, setWalking] = useState(0);
  const [completed, setCompleted] = useState(0);
  const [light, setLight] = useState(false);

  /*
  useEffect(() => {
    console.log("pending effect:", pending);
  }, [pending]);
  */

  function handleTrafficLightClick() {
    //console.log("before", pending);
    setPending((p) => p - 10);
    //console.log("after", pending);
    setWalking((w) => w + 10);
    setLight(true); // Set light to green when walking starts
    setTimeout(() => {
      setWalking((w) => w - 10);
      setCompleted((c) => c + 10);
      setLight(false); // Set light to red when walking is completed
    }, 5000); // Delay for 3000 milliseconds (5 seconds)
  }

  return (
    <>
      <h3 style={{ color: light ? "grey" : "white" }}> 
        Pending: {pending} </h3>
      <h3 style={{ color: light ? "white" : "grey" }}>
        Walking: {walking} {light ? " . . . . ." : ""}
      </h3>
      <h3 style={{ color: light ? "green" : "grey" }}>
        Completed: {completed}
      </h3>
      <button
        onClick={handleTrafficLightClick}
        style={{
          backgroundColor: light ? "green" : "red",
          padding: "10px 24px",
          borderRadius: "8px",
          border: "none",
          color: "white",
          fontSize: "20px",
        }}
      >
        Taffic Light
      </button>
    </>
  );
}


```
:::

## Adding graphics & improving business logic

> React component called **TrafficLightSimulation**: It simulates a pedestrian crossing at a traffic light.

::: {.column-margin}
The code provides an interactive simulation of a traffic light pedestrian crossing using React.
:::

The component initializes with a random number of people waiting to cross (`peopleToWalk`) and a random number of people allowed to cross in each group (`groupWalking`).

When the traffic light is clicked, it turns `green`, and pedestrians start crossing in groups according to the `groupWalking` limit.

The component visually represents `pending` pedestrians, `walking` pedestrians, and `completed` crossings. When all pedestrians have crossed, a "`Play Again`" button appears to refresh the page and start the simulation again.

The `useMemo` hook ensures that the initial values for `peopleToWalk` and `groupWalking` **remain constant throughout the component's lifecycle.** 

The `useState` hook **manages the state of the crossing simulation**.


- [trafficlights: graphics](https://github.com/AlbertProfe/trafficlights/tree/f847634752f6109d5575417c8505634451656d6f){.external target='_blank'}
- [App.jsx](https://github.com/AlbertProfe/trafficlights/blob/f847634752f6109d5575417c8505634451656d6f/src/App.jsx){.external target='_blank'}

::: {.column-page-right}

<details>
<summary>App.jsx with graphics</summary>

```{.js .code-overflow-wrap filename="App.jsx"}

import { useState, useMemo } from "react";

function getRandomInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function getRandomColor() {
  const colors = 
        ["red", "blue", "green", "yellow", "purple", "orange"];
  return colors[getRandomInt(0, colors.length - 1)];
}

function refreshPage() {
  window.location.reload(false);
}

export default function TrafficLightSimulation() {
  
  // total people to walk, to cross  the traffic lights
  const initPeopleToWalk = 
        useMemo(() => getRandomInt(10, 20), []);
        // Initialize peopleToWalk with a 
        //random value that remains constant
  const peopleToWalk = 
        useMemo(() => initPeopleToWalk, []); 
        // peopleToWalk does not change along all the execution
  
  // people will cross by gropus, the value is random each time
  // each time traffic ights are green the group
  // will cross one by one to complete the lights cycle
  const initGroupWalking = getRandomInt(2, 6);

  const [crossing, setCrossing] = useState({
    pending: peopleToWalk,
    walking: 0,
    completed: 0,
    groupWalking: initGroupWalking,
    light: false,
  });

  function handleTrafficLightClick() {
    setCrossing((prevState) => ({
      ...prevState,
      light: true,
    }));

    let walked = 0;
    let maxToWalk = 0;
    const walkingInterval = setInterval(() => {
      const { pending, groupWalking } = crossing;
      if (groupWalking >= pending) maxToWalk = pending;
      else maxToWalk = groupWalking;

      if (walked < maxToWalk) {
        setCrossing((prevState) => ({
          ...prevState,
          walking: prevState.walking + 1,
          pending: prevState.pending - 1,
        }));
        walked++;
      } else {
        clearInterval(walkingInterval);
        setCrossing((prevState) => ({
          ...prevState,
          completed: prevState.completed + walked,
          walking: 0,
          light: false,
          groupWalking: initGroupWalking,
        }));
      }
    }, 1000);
  }

  const { pending, walking, completed, groupWalking, light } = crossing;

  return (
    <>
      <div style={{ textAlign: "center" }}>
        <h1>Traffic Light Crossing Simulation</h1>
        <h4>Help pedestrians cross the street safely!</h4>{" "}
        <div className="chip">
         {peopleToWalk} people want to cross the pedestrian/zebra crossing
         </div><p></p>
        {completed === peopleToWalk ? (
          <button
            onClick={refreshPage}
            style={{
              backgroundColor: "black",
              padding: "10px 24px",
              borderRadius: "8px",
              border: "none",
              color: "white",
              fontSize: "20px",
              marginBottom: "20px",
            }}
          >
            Play Again (refresh page)
          </button>
        ) : (
          <>
            <button
              onClick={handleTrafficLightClick}
              style={{
                backgroundColor: light ? "green" : "red",
                padding: "10px 24px",
                borderRadius: "8px",
                border: "none",
                color: "white",
                fontSize: "20px",
                marginBottom: "20px",
              }}
            >
              Traffic Light
            </button>

            <div
              style={{
                display: "flex",
                flexDirection: "row",
                justifyContent: "center",
              }}
            >
              <h3>Group walking: {groupWalking} </h3>
              {Array.from({ length: groupWalking }).map((_, index) => (
                <div
                  key={index}
                  style={{
                    backgroundColor: "blue",
                    width: "10px",
                    height: "10px",
                    margin: "2px",
                  }}
                />
              ))}
            </div>
          </>
        )}
        <div style={{ display: "flex", justifyContent: "space-between" }}>
          <div>
            <h3>Pending: {pending}</h3>
            {Array.from({ length: pending }).map((_, index) => (
              <div
                key={index}
                style={{
                  backgroundColor: getRandomColor(),
                  width: "10px",
                  height: "10px",
                  margin: "2px",
                }}
              />
            ))}
          </div>
          <div>
            <h3>Walking: {walking}</h3>
            {Array.from({ length: walking }).map((_, index) => (
              <div
                key={index}
                style={{
                  backgroundColor: "blue",
                  width: "10px",
                  height: "10px",
                  margin: "2px",
                }}
              />
            ))}
          </div>
          <div>
            <h3>Completed: {completed}</h3>
            {Array.from({ length: completed }).map((_, index) => (
              <div
                key={index}
                style={{
                  backgroundColor: "green",
                  width: "10px",
                  height: "10px",
                  margin: "2px",
                }}
              />
            ))}
          </div>
        </div>
      </div>
    </>
  );
}
```

</details>

:::


`prevState` is used as an argument in the functional update form of the `setCrossing` function, **which is part of React's useState hook**. 

> This functional form allows you to access the previous state of the component's state variable (in this case, `crossing`) and perform updates based on that previous state.

::: {.column-page-right}

```{.js .code-overflow-wrap filename="App.jsx"}

// functions ...

export default function TrafficLightSimulation() {
  
// code ...

  const [crossing, setCrossing] = useState({
    pending: peopleToWalk,
    walking: 0,
    completed: 0,
    groupWalking: initGroupWalking,
    light: false,
  });

  function handleTrafficLightClick() {
    setCrossing((prevState) => ({
      ...prevState,
      light: true,
    }));

    let walked = 0;
    let maxToWalk = 0;
    const walkingInterval = setInterval(() => {
      const { pending, groupWalking } = crossing;
      if (groupWalking >= pending) maxToWalk = pending;
      else maxToWalk = groupWalking;

      if (walked < maxToWalk) {
        setCrossing((prevState) => ({
          ...prevState,
          walking: prevState.walking + 1,
          pending: prevState.pending - 1,
        }));
        walked++;
      } else {
        clearInterval(walkingInterval);
        setCrossing((prevState) => ({
          ...prevState,
          completed: prevState.completed + walked,
          walking: 0,
          light: false,
          groupWalking: initGroupWalking,
        }));
      }
    }, 1000);
  }

  return (
    <>
    </>
  );
}
```
:::


1. When updating the state using `setCrossing`, the code utilizes the functional form `(prevState) => { ... }`.
   - This function receives the previous state (`prevState`) as an argument and returns the new state based on that previous state.

2. Inside the function, the **spread operator** (`...prevState`) is used to create a shallow copy of the previous state object.
   1. This ensures that **you are not mutating the original state directly**, which is important for maintaining the immutability of React state.

3. The properties of the state object are then modified according to the logic defined in the function.
   - In the first part of the code block, `walking` is incremented by 1 and `pending` is decremented by 1.
    - In the second part of the code block (the `else` block), various properties of the state object are updated based on some condition.
  
4. `prevState` is not a reserved word in React; rather, it's a variable name used conventionally to refer to the previous state in functional updates when using the `useState` hook.
   1.  It's a common practice in React to use `prevState` as the parameter name in functional updates, but it's not enforced by React itself.
   2.  You could technically use **any valid variable name in its place**, but using `prevState` makes the code more readable and understandable for other developers who are familiar with React conventions.


::: {.callout-note}

By using `prevState` in this manner, the code ensures that the state updates are based on the previous state, rather than relying on the current state directly. This is important because React's state updates may be asynchronous, and accessing the previous state via the functional form ensures that the updates are based on the most recent state at the time the update is applied.

::::

![render v0.1 render(1)](/images/reactjs/traffic-render-v0.1-1.png)

## Consolidation and merge: `literal object`

The operation of consolidating multiple state variables into a single object using the useState hook and the spread operator can be referred to as state consolidation or state merging.

Here's a breakdown:

- **State Consolidation**: This term emphasizes the process of bringing together multiple individual state variables into a single, cohesive object. It highlights the idea of simplifying state management by grouping related pieces of state.
- **State Merging**: This term underscores the use of the spread operator (...) to merge the previous state with the updated state when setting the state. It emphasizes the technique used to update multiple properties of the state object simultaneously.


## Adding domains: router

to-do

## Adding form: login & fake-token

to-do

## Adding server: axios & mockapi

to-do

# Code

::: {.column-page-right}

| Code Version | Commit | Folder-Tree | Output |
| -- | -- | -- | -- |
| [GitHub code v0.0](https://github.com/AlbertProfe/trafficlights/tree/5219b5acb611bd3c7faba7b22b14e0fd49f38b45){.external target='_blank'}  | create project (React Vite) and core business logic | [Basic Structure](/images/reactjs/traffic-project-v0.0-1.png){.external target='_blank'} | [render v0.0 render(1)](/images/reactjs/traffic-render-v0.0-1.png){.external target='_blank'}, [render v0.0 render(2)](/images/reactjs/traffic-render-v0.0-2.png){.external target='_blank'}, [render v0.0 render(3)](/images/reactjs/traffic-render-v0.0-3.png){.external target='_blank'} |
| [GitHub code v0.1](https://github.com/AlbertProfe/trafficlights/tree/f847634752f6109d5575417c8505634451656d6f){.external target='_blank'}  | adding graphics, simulation ending, refresh `button`, groups crossing and random values |  |  [render v0.1 render(1)](/images/reactjs/traffic-render-v0.1-1.png){.external target='_blank'}, [render v0.1 render(2)](/images/reactjs/traffic-render-v0.1-2.png){.external target='_blank'}, [render v0.1 render(3)](/images/reactjs/traffic-render-v0.1-3.png){.external target='_blank'}, [render v0.1 render(4)](/images/reactjs/traffic-render-v0.1-4.png){.external target='_blank'} |

:::



<!--- navLinks -->
<br><br>
<div class=row>
<br>
<div class='column left previous'>
<br>
[{{< fa solid arrow-left >}} React JS: Lab#RE06-1-PR  ](/reactjs/rjslab6-1-PR.qmd)
<br>
</div>
<br>
<div class='column center'>
<br>
[{{< fa solid arrow-up >}} top](#top)
<br>
</div>
<br>
<div class='column right next'>
<br>
[ReactJS Resources  {{< fa solid arrow-right >}}](/reactjs/resources.qmd)
<br>
</div>
<br>
</div>
